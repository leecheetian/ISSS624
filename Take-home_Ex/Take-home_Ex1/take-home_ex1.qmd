---
title: "Take-home Exercise 1"
author: "Lee Chee Tian"
editor: visual
---

# Geospatial Analytics for Social Good

## Objective

To reveal the geospatial patterns of Not Functional water points in Nigeria using global and local spatial association techniques.

## Loading R Packages

```{r}
pacman::p_load(sf, spdep, tmap, tidyverse)
```

## Importing Data into R

### The Data

![](nigeria%20adm2%20geospatial%20data.jpg)

![](nigeria%20aspatial%20data.jpg)

As the size of the CSV file has exceeded the GitHub limitation of 100 MB, it shall not be included in the Commit and Push to GitHub and Netlify. The wrangled data derived from the following steps for the subsequent geospatial analysis will be exported as a RDS file, and this will be pushed to GitHub and Netlify instead.

### Importing shapefile and Transforming to EPSG 26391 Map Projection

```{r}
nigeria_sf <- st_read(dsn="data/Nigeria", layer="geoBoundaries-NGA-ADM2")
```

```{r}
plot(nigeria_sf)
```

```{r}
glimpse(nigeria_sf)
```

```{r}
nigeria26391 <- st_transform(nigeria_sf, crs = 26391)
nigeria26391
```

### Importing Aspatial Data

```{r}
WPdx_csv <- read_csv("data/WPdx+/Water_Point_Data_Exchange_-_Plus__WPdx__.csv")
```

#### Data Wrangling

Retrieving data for Nigeria only and where functional status is known.

```{r}
nigeria_data <- WPdx_csv %>%
  filter(`#country_name` == "Nigeria") %>%
  drop_na(`#status`) %>%
  group_by(`#adm2`) %>%
  mutate(`functionality` = case_when(grepl("^Functional", `#status`) 
                                     ~ "Functional", 
                                     TRUE ~ "Non-functional")) %>%
  count(`functionality`) %>%
  pivot_wider(names_from = `functionality`, values_from = n) %>%
  mutate(`f2nfrate` = ifelse(!is.na(`Functional`) & !is.na(`Non-functional`), 
                             `Functional` / `Non-functional`,
                              ifelse(!is.na(`Functional`), 
                                     `Functional`, 0)))
```

```{r}
nigeria_data
```

The following assumptions were taken in the calculation of the Functional-to-Non-functional ratio, *f2nfrate*, of the water points in each Local Government Area (LGA):

-   For LGAs with both Functional and Non-functional water point records, the *f2nfrate* is calculated by the count of the former divided by the count of the latter.

-   For LGAs with only Functional water point records but no Non-functional water point records, the *f2nfrate* is assigned the count of the Functional water points (ie. assuming the Non-functional water point count is 1), as it is not feasible to divide by 0.

-   For LGAs with only Non-functional water point records and no Functional water point records, the *f2nfrate* is assigned as 0.

### Joining the Aspatial Data and the Geospatial Data

```{r}
nigeria_WPdx <- left_join(nigeria26391, nigeria_data, 
                          by = c("shapeName" = "#adm2"))
```

```{r}
nigeria_WPdx
```

```{r}
write_rds(nigeria_WPdx, "data/rds/nigeria_WPdx.rds")
```

```{r}
nigeria_WPdx <- read_rds("data/rds/nigeria_WPdx.rds")
```

```{r}
nigeria_WPdx
```

## Plotting Thematic Map of Water Point Data

```{r}
fmap <- tm_shape(nigeria_WPdx) +
  tm_polygons("Functional", title = "Functional count", 
              style = "jenks", palette = "Blues", n = 6, border.alpha = 0.5) +
  tm_layout(legend.outside = TRUE)
  
nfmap <- tm_shape(nigeria_WPdx) +
  tm_polygons("Non-functional", title = "Non-functional count", 
              style = "jenks", palette = "Oranges", n = 6, border.alpha = 0.5) +
  tm_layout(legend.outside = TRUE)

f2nfmap <- tm_shape(nigeria_WPdx) +
  tm_polygons("f2nfrate", title = "Functional to Non-functional ratio", 
              style = "jenks", palette = "Greens", n = 6, border.alpha = 0.5) +
  tm_layout(legend.outside = TRUE) 

tmap_arrange(fmap, nfmap, f2nfmap, ncol=1)
```

It appears the functional water points are mostly concentrated in the northern regions of Nigeria, and corresponds to a higher functional-to-non-functional ratio. The central and southern regions see a higher number of non-functional water points and lower functional-to-non-functional ratio in contrast.

## Cluster and Outlier Analysis

### Computing Contiguity Spatial Weights

```{r}
wm_q <- poly2nb(nigeria_WPdx, queen = TRUE)
summary(wm_q)
```

### Row-Standardized Weights Matrix

```{r}
rswm_q <- nb2listw(wm_q, style = "W", zero.policy = TRUE)
print(rswm_q, zero.policy = TRUE)
```

### Global Spatial Autocorrelation: Moran's I test

```{r}
moran.test(nigeria_WPdx$f2nfrate, 
           listw = rswm_q, 
           zero.policy = TRUE, 
           na.action = na.omit)
```

The positive Moran's I value of 0.1753 and low p-value of \< 0.05 suggest that there is clustering and positive spatial autocorrelation of the functional-to-non-functional ratio of the water points among the LGAs, and the null hypothesis of spatial randomness is rejected.

### Computing Local Moran's I

```{r}
fips <- order(nigeria_WPdx$shapeName)
localMI <- localmoran(nigeria_WPdx$f2nfrate, rswm_q, zero.policy = TRUE,
                      na.action = na.exclude)
head(localMI)
```

```{r}
printCoefmat(data.frame(localMI[fips,], 
                        row.names = nigeria_WPdx$shapeName[fips]), 
             check.names = FALSE)
```
